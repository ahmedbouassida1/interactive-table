<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrice des Privilèges et Accès des Acteurs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
            background-color: #e6fafe;
            padding: 1.5rem;
        }
        .tab-active {
            background-color: #4338ca;
            color: white;
        }
        .edit-btn {
            border-radius: 50%;
            transition: background 0.2s;
        }
        .edit-btn:hover,
        .edit-btn-active {
            background: #d0edfd;
        }
        .sub-tab-active {
            border-bottom: 2px solid #4f46e5;
            color: #4f46e5;
        }
        .table-header-text {
            color: #333365;
        }
        .divide-y > :not([hidden]) ~ :not([hidden]) {
            border-color: #d9d9fe;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #22c55e;
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
    </style>
</head>
<body>
    <div id="privilege-matrix" class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="p-6 sm:p-8">
            <div class="flex justify-between items-center mb-2">
                 <h1 class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-700">Tableau des Privilèges et Accès</h1>
                 <button id="edit-button" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">
                    <span id="edit-btn-circle" class="edit-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </span>
                 </button>
            </div>
            <p class="text-gray-500">Naviguez entre les acteurs et les plateformes pour voir les permissions.</p>
        </div>

        <div class="px-6 sm:px-8 border-b border-gray-200">
            <nav id="main-tabs" class="flex flex-wrap -mb-px" aria-label="Tabs">
            </nav>
        </div>

        <div id="tab-content" class="p-6 sm:p-8">
        </div>
        
        <div id="edit-controls-container" class="p-6 sm:p-8 flex justify-between items-center" style="display: none;">
            <button id="add-functionality-button" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition-colors">Ajouter une fonctionnalité</button>
            <div class="flex items-center space-x-4">
                <button id="reset-button" class="text-sm font-medium text-gray-600 hover:text-gray-800">Réinitialiser</button>
                <button id="cancel-button" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors">Annuler</button>
                <button id="save-button" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition-colors">Enregistrer</button>
            </div>
        </div>
    </div>

    <footer class="text-center mt-8 text-sm text-gray-500">
        <p>&copy; 2025 iLocker Tunisie. Tous droits réservés.</p>
        <a href="https://ilocker.com.tn" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">ilocker.com.tn</a>
    </footer>

    <script>
        const originalData = {
            webFunctionalities: [ "Authentification (Web)", "Gestion des Utilisateurs", "Visualisation Géolocalisée Appareils", "Planification Interventions", "Supervision Interventions", "Attribuer des interventions", "Consultation Historique Interventions", "Export Rapports Interventions", "Notifications & Alertes (Web)", "Création/Approbation Actualités", "Reporting", "Enregistrement des chauffe-eaux fabriqués", "Déclaration des ventes" ],
            mobileFunctionalities: [ "Authentification (Mobile)", "Notifications & Alertes (Mobile)", "Consultation Actualités (Mobile)", "Enregistrement Appareils", "Exécution Interventions", "Suivi détaillé Interventions", "Scan de QR Code", "Consultation Historique Interventions (Mobile)", "Déclaration des Ventes" ],
            actors: { "ANME": { web: { "Authentification (Web)": true, "Visualisation Géolocalisée Appareils": true }, mobile: { "Authentification (Mobile)": true, "Notifications & Alertes (Mobile)": true, "Enregistrement Appareils": true } }, "Usine": { web: { "Authentification (Web)": true, "Enregistrement des chauffe-eaux fabriqués": true, "Reporting": true }, mobile: {} }, "Administrateur Système": { web: { "Authentification (Web)": true, "Gestion des Utilisateurs": true, "Planification Interventions": true, "Supervision Interventions": true, "Déclaration des ventes": true, "Reporting": true, "Attribuer des interventions": true, "Consultation Historique Interventions": true, "Export Rapports Interventions": true, "Notifications & Alertes (Web)": true }, mobile: { "Authentification (Mobile)": true, "Notifications & Alertes (Mobile)": true, "Enregistrement Appareils": true, "Déclaration des Ventes": true } }, "Installateur Agréé": { web: { "Authentification (Web)": true, "Visualisation Géolocalisée Appareils": true, "Planification Interventions": true, "Consultation Historique Interventions": true, "Export Rapports Interventions": true, "Notifications & Alertes (Web)": true, "Création/Approbation Actualités": true, "Déclaration des ventes": true }, mobile: { "Authentification (Mobile)": true, "Exécution Interventions": true, "Suivi détaillé Interventions": true, "Scan de QR Code": true, "Consultation Historique Interventions (Mobile)": true, "Notifications & Alertes (Mobile)": true, "Consultation Actualités (Mobile)": true, "Déclaration des Ventes": true } }, "Réparateur Agréé": { web: { "Authentification (Web)": true, "Visualisation Géolocalisée Appareils": true, "Planification Interventions": true, "Consultation Historique Interventions": true, "Export Rapports Interventions": true, "Notifications & Alertes (Web)": true, "Création/Approbation Actualités": true }, mobile: { "Authentification (Mobile)": true, "Exécution Interventions": true, "Suivi détaillé Interventions": true, "Scan de QR Code": true, "Consultation Historique Interventions (Mobile)": true, "Notifications & Alertes (Mobile)": true, "Consultation Actualités (Mobile)": true } } }
        };

        // Load from localStorage if available
        let webFunctionalities, mobileFunctionalities, actors;
        if (localStorage.getItem('privMatrixActors')) {
            actors = JSON.parse(localStorage.getItem('privMatrixActors'));
        } else {
            actors = JSON.parse(JSON.stringify(originalData.actors));
        }
        if (localStorage.getItem('privMatrixWeb')) {
            webFunctionalities = JSON.parse(localStorage.getItem('privMatrixWeb'));
        } else {
            webFunctionalities = JSON.parse(JSON.stringify(originalData.webFunctionalities));
        }
        if (localStorage.getItem('privMatrixMobile')) {
            mobileFunctionalities = JSON.parse(localStorage.getItem('privMatrixMobile'));
        } else {
            mobileFunctionalities = JSON.parse(JSON.stringify(originalData.mobileFunctionalities));
        }
        let dataBackup = {};

        const mainTabsContainer = document.getElementById('main-tabs');
        const contentContainer = document.getElementById('tab-content');
        const editControlsContainer = document.getElementById('edit-controls-container');
        
        let activeActor = Object.keys(actors)[0];
        let activePlatform = 'web';
        let sortOrder = 'none';
        let isEditMode = false;

        function renderContent() {
            const actorPermissions = actors[activeActor][activePlatform];
            let masterList = [...(activePlatform === 'web' ? webFunctionalities : mobileFunctionalities)];

            if (sortOrder !== 'none' && !isEditMode) {
                masterList.sort((a, b) => {
                    const accessA = actorPermissions[a] || false;
                    const accessB = actorPermissions[b] || false;
                    return sortOrder === 'desc' ? (accessB - accessA) : (accessA - accessB);
                });
            }

            const subTabsHTML = `
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-4" aria-label="Sub-tabs">
                        <button onclick="setPlatform('web')" class="sub-tab ${activePlatform === 'web' ? 'sub-tab-active' : 'text-gray-500 hover:text-gray-700'} px-3 py-2 font-medium text-sm rounded-t-md">Web</button>
                        <button onclick="setPlatform('mobile')" class="sub-tab ${activePlatform === 'mobile' ? 'sub-tab-active' : 'text-gray-500 hover:text-gray-700'} px-3 py-2 font-medium text-sm rounded-t-md">Mobile</button>
                    </nav>
                </div>
            `;
            
            let tableHTML = '<p class="text-gray-500">Aucune fonctionnalité pour cette plateforme.</p>';
            if (masterList.length > 0) {
                tableHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th scope="col" class="table-header-text px-6 py-3 text-left text-sm font-semibold uppercase tracking-wider">Fonctionnalité</th>
                                    <th scope="col" class="px-6 py-3 text-center text-sm font-semibold uppercase tracking-wider">
                                        <div class="table-header-text flex items-center justify-center space-x-2">
                                            <span>Accès</span>
                                            <button id="sort-button" class="p-1 rounded-full hover:bg-indigo-200 ${isEditMode ? 'hidden' : ''}">
                                                <svg class="w-4 h-4" style="color: #333365;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg>
                                            </button>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y" id="features-tbody">
                                ${masterList.map((featureName) => {
                                    const hasAccess = actorPermissions[featureName] || false;
                                    return `
                                        <tr data-feature-name="${featureName}">
                                            <td class="px-6 py-4 whitespace-nowrap text-base font-medium text-gray-800">
                                                ${isEditMode ? `<input type="text" value="${featureName}" class="w-full p-1 border rounded feature-name-input" />` : featureName}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                                ${isEditMode ? `
                                                    <label class="switch">
                                                        <input type="checkbox" ${hasAccess ? 'checked' : ''} class="access-toggle">
                                                        <span class="slider round"></span>
                                                    </label>
                                                ` : (hasAccess ? '<span class="text-green-600 font-bold text-2xl">✓</span>' : '<span class="text-red-500 font-bold text-2xl">✗</span>')}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            contentContainer.innerHTML = subTabsHTML + tableHTML;
            renderMainTabs();
            
            if (!isEditMode) {
                document.getElementById('sort-button').addEventListener('click', () => {
                    sortOrder = sortOrder === 'none' ? 'desc' : (sortOrder === 'desc' ? 'asc' : 'none');
                    renderContent();
                });
            }
        }
        
        function renderMainTabs() {
            mainTabsContainer.innerHTML = Object.keys(actors).map(actorName => `
                <button onclick="setActor('${actorName}')" class="main-tab ${activeActor === actorName ? 'tab-active' : 'text-gray-600 hover:bg-gray-100'} text-sm font-medium text-center py-3 px-4 rounded-t-lg transition-colors duration-200">
                    ${actorName.replace(/_/g, ' ')}
                </button>
            `).join('');
        }

        function setEditMode(enabled) {
            isEditMode = enabled;
            sortOrder = 'none';
            editControlsContainer.style.display = enabled ? 'flex' : 'none';
            if (enabled) {
                dataBackup = {
                    actors: JSON.parse(JSON.stringify(actors)),
                    webFunctionalities: JSON.parse(JSON.stringify(webFunctionalities)),
                    mobileFunctionalities: JSON.parse(JSON.stringify(mobileFunctionalities))
                };
                if (editBtnCircle) editBtnCircle.classList.add('edit-btn-active');
            } else {
                if (editBtnCircle) editBtnCircle.classList.remove('edit-btn-active');
            }
            renderContent();
        }

        window.setActor = (actorName) => { if (!isEditMode) { activeActor = actorName; activePlatform = 'web'; renderContent(); } }
        window.setPlatform = (platformName) => { if (!isEditMode) { activePlatform = platformName; renderContent(); } }

        const editBtnCircle = document.getElementById('edit-btn-circle');
        document.getElementById('edit-button').addEventListener('click', () => {
            setEditMode(true);
            if (editBtnCircle) editBtnCircle.classList.add('edit-btn-active');
        });
        document.getElementById('cancel-button').addEventListener('click', () => {
            actors = dataBackup.actors;
            webFunctionalities = dataBackup.webFunctionalities;
            mobileFunctionalities = dataBackup.mobileFunctionalities;
            setEditMode(false);
            if (editBtnCircle) editBtnCircle.classList.remove('edit-btn-active');
        });
        document.getElementById('reset-button').addEventListener('click', () => {
            actors = JSON.parse(JSON.stringify(originalData.actors));
            webFunctionalities = JSON.parse(JSON.stringify(originalData.webFunctionalities));
            mobileFunctionalities = JSON.parse(JSON.stringify(originalData.mobileFunctionalities));
            // Clear localStorage
            localStorage.removeItem('privMatrixActors');
            localStorage.removeItem('privMatrixWeb');
            localStorage.removeItem('privMatrixMobile');
            renderContent();
        });

        document.getElementById('add-functionality-button').addEventListener('click', () => {
            const tbody = document.getElementById('features-tbody');
            const newRow = document.createElement('tr');
            newRow.dataset.isNew = "true";
            newRow.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-base font-medium text-gray-800">
                    <input type="text" placeholder="Nouvelle fonctionnalité" class="w-full p-1 border rounded feature-name-input" />
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                    <label class="switch">
                        <input type="checkbox" class="access-toggle">
                        <span class="slider round"></span>
                    </label>
                </td>
            `;
            tbody.appendChild(newRow);
        });

        document.getElementById('save-button').addEventListener('click', () => {
            const rows = document.querySelectorAll('#features-tbody tr');
            const newPermissionsForCurrentActor = {};
            
            rows.forEach(row => {
                const nameInput = row.querySelector('.feature-name-input');
                const accessToggle = row.querySelector('.access-toggle');
                const newName = nameInput.value.trim();
                const originalName = row.dataset.featureName;
                const hasAccess = accessToggle.checked;

                if (row.dataset.isNew === "true") {
                    if (newName) {
                        const masterList = activePlatform === 'web' ? webFunctionalities : mobileFunctionalities;
                        if (!masterList.includes(newName)) {
                            masterList.push(newName);
                        }
                        Object.keys(actors).forEach(actor => {
                            actors[actor][activePlatform][newName] = (actor === activeActor) ? hasAccess : false;
                        });
                        newPermissionsForCurrentActor[newName] = hasAccess;
                    }
                } else {
                    // Handle renaming of existing functionality
                    const masterList = activePlatform === 'web' ? webFunctionalities : mobileFunctionalities;
                    if (newName && newName !== originalName) {
                        // Update master list
                        const idx = masterList.indexOf(originalName);
                        if (idx !== -1) masterList[idx] = newName;
                        // Update all actors' permissions
                        Object.keys(actors).forEach(actor => {
                            const perms = actors[actor][activePlatform];
                            perms[newName] = perms[originalName];
                            delete perms[originalName];
                        });
                        newPermissionsForCurrentActor[newName] = hasAccess;
                    } else {
                        newPermissionsForCurrentActor[originalName] = hasAccess;
                    }
                }
            });
            
            actors[activeActor][activePlatform] = newPermissionsForCurrentActor;
            // Save to localStorage
            localStorage.setItem('privMatrixActors', JSON.stringify(actors));
            localStorage.setItem('privMatrixWeb', JSON.stringify(webFunctionalities));
            localStorage.setItem('privMatrixMobile', JSON.stringify(mobileFunctionalities));
            setEditMode(false);
        });

        renderContent();
    </script>
</body>
</html>
